<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OrbRPG 3D Preview - Warrior</title>
    <style>
        * { margin: 0; padding: 0; }
        body { background: #000; font-family: Arial, sans-serif; overflow: hidden; }
        #canvas { width: 100%; height: 100vh; display: block; }
        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            color: #fff;
            padding: 20px;
            border: 2px solid #d4af37;
            z-index: 10;
            font-size: 14px;
            max-width: 400px;
        }
        #info h2 { color: #d4af37; margin-bottom: 10px; }
        #status { margin-top: 10px; padding-top: 10px; border-top: 1px solid #d4af37; color: #aaa; font-size: 12px; }
        .error { color: #ff6666; }
        .success { color: #66ff66; }
    </style>
</head>
<body>
    <div id="info">
        <h2>OrbRPG 3D Viewer</h2>
        <p id="modelName">Loading...</p>
        <div id="status">Initializing Three.js...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@r128/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        const statusEl = document.getElementById('status');
        const modelNameEl = document.getElementById('modelName');

        // Embedded Warrior Test.glb as base64
        const WARRIOR_MODEL_B64 = "H4sICJ4r4mYAL1dhcnJpb3IgVGVzdC5nbGIBK";

        async function loadEmbeddedModel() {
            try {
                // Get the model from URL parameter or use default
                const urlParams = new URLSearchParams(window.location.search);
                const modelName = urlParams.get('model') || 'Warrior Test.glb';
                modelNameEl.textContent = modelName;

                // For now, we'll load from file since embedding the full base64 would be very large
                // This file should exist in the same directory
                const modelPath = './' + encodeURIComponent(modelName);
                statusEl.innerHTML = `<span class="success">✓</span> Loading model from: ${modelName}<br>`;
                
                // Create Three.js scene
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x1a1a1a);

                const camera = new THREE.PerspectiveCamera(
                    75,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    1000
                );
                camera.position.set(0, 1, 3);
                camera.lookAt(0, 0, 0);

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                document.body.appendChild(renderer.domElement);

                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 10, 7);
                scene.add(directionalLight);

                // Load model
                const loader = new THREE.GLTFLoader();
                
                loader.load(
                    modelPath,
                    (gltf) => {
                        const model = gltf.scene;
                        scene.add(model);

                        // Center and scale
                        const box = new THREE.Box3().setFromObject(model);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());

                        model.position.sub(center);
                        const maxDim = Math.max(size.x, size.y, size.z);
                        const scale = 2 / maxDim;
                        model.scale.multiplyScalar(scale);

                        // Count meshes and materials
                        let meshCount = 0;
                        let materialCount = 0;
                        model.traverse((child) => {
                            if (child instanceof THREE.Mesh) {
                                meshCount++;
                                if (child.material) {
                                    if (Array.isArray(child.material)) {
                                        materialCount += child.material.length;
                                    } else {
                                        materialCount++;
                                    }
                                }
                            }
                        });

                        statusEl.innerHTML = `
                            <span class="success">✓ Model Loaded!</span><br>
                            Meshes: ${meshCount}<br>
                            Materials: ${materialCount}<br>
                            <br>
                            <strong>Controls:</strong><br>
                            • Drag to rotate<br>
                            • Scroll to zoom<br>
                            • F12 for console
                        `;

                        console.log(`Model loaded: ${meshCount} meshes, ${materialCount} materials`);
                    },
                    (progress) => {
                        const percent = Math.round((progress.loaded / progress.total) * 100);
                        statusEl.innerHTML = `<span class="success">✓</span> Loading: ${percent}%`;
                    },
                    (error) => {
                        console.error('Load error:', error);
                        statusEl.innerHTML = `
                            <span class="error">✗ Failed to load model</span><br>
                            <br>
                            <strong>Troubleshooting:</strong><br>
                            • Is "${modelName}" in the same directory?<br>
                            • Check browser console (F12) for details<br>
                            • Try opening from an HTTP server
                        `;
                    }
                );

                // Animation loop
                function animate() {
                    requestAnimationFrame(animate);
                    renderer.render(scene, camera);
                }
                animate();

                // Camera controls
                let isDragging = false;
                let previousMousePosition = { x: 0, y: 0 };

                renderer.domElement.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                });

                renderer.domElement.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        const deltaX = e.clientX - previousMousePosition.x;
                        const deltaY = e.clientY - previousMousePosition.y;
                        
                        const scene = renderer.scene;
                        scene.rotation.y += deltaX * 0.01;
                        scene.rotation.x += deltaY * 0.01;
                        
                        previousMousePosition = { x: e.clientX, y: e.clientY };
                    }
                });

                renderer.domElement.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                renderer.domElement.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    camera.position.z += e.deltaY * 0.001;
                    camera.position.z = Math.max(0.5, Math.min(10, camera.position.z));
                });

                // Handle window resize
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });

            } catch (err) {
                console.error('Error:', err);
                statusEl.innerHTML = `<span class="error">✗ Error: ${err.message}</span>`;
            }
        }

        // Start loading when page loads
        window.addEventListener('load', () => {
            loadEmbeddedModel();
        });
    </script>
</body>
</html>
