<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OrbRPG 3D Viewer</title>
    <style>
        * { margin: 0; padding: 0; }
        body {
            width: 100vw;
            height: 100vh;
            background: #000;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }
        canvas { flex: 1; display: block; }
        #ui {
            background: #1a1a1a;
            color: #fff;
            padding: 15px;
            border-top: 1px solid #666;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        input[type="file"] {
            padding: 8px;
            background: #333;
            border: 1px solid #666;
            color: #fff;
            cursor: pointer;
            flex: 1;
        }
        #status {
            padding: 8px 15px;
            background: #2a2a2a;
            border-radius: 4px;
            font-size: 12px;
            min-width: 250px;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="ui">
        <input type="file" id="fileInput" accept=".glb,.gltf">
        <div id="status">Loading Three.js...</div>
    </div>

    <script async src="https://cdn.jsdelivr.net/npm/three@r128/build/three.min.js"></script>
    <script async src="https://cdn.jsdelivr.net/npm/three@r128/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        console.log('Viewer script loaded');
        
        let scene, camera, renderer, model;
        
        // Wait for THREE to load
        function waitForTHREE(callback) {
            if (window.THREE) {
                callback();
            } else {
                setTimeout(() => waitForTHREE(callback), 100);
            }
        }

        function init() {
            console.log('Initializing scene with THREE version:', THREE.REVISION);
            
            const canvas = document.getElementById('canvas');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;
            
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // Lights
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);
            
            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                if (model) model.rotation.y += 0.005;
                renderer.render(scene, camera);
            }
            animate();
            
            // Mouse
            let isDragging = false, mouse = { x: 0, y: 0 };
            renderer.domElement.addEventListener('mousedown', (e) => {
                isDragging = true;
                mouse = { x: e.clientX, y: e.clientY };
            });
            renderer.domElement.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - mouse.x;
                const dy = e.clientY - mouse.y;
                scene.rotation.y += dx * 0.01;
                scene.rotation.x += dy * 0.01;
                mouse = { x: e.clientX, y: e.clientY };
            });
            renderer.domElement.addEventListener('mouseup', () => isDragging = false);
            renderer.domElement.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.001;
                camera.position.z = Math.max(0.5, Math.min(20, camera.position.z));
            });
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            
            document.getElementById('status').textContent = '✓ Ready - select model';
            console.log('✓ Scene initialized');
        }

        function loadModel(file) {
            console.log('Loading:', file.name);
            document.getElementById('status').textContent = `Loading: ${file.name}...`;
            
            const url = URL.createObjectURL(file);
            const loader = new THREE.GLTFLoader();
            
            loader.load(url, (gltf) => {
                if (model) scene.remove(model);
                model = gltf.scene;
                scene.add(model);
                
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                model.position.sub(center);
                
                const scale = 4 / Math.max(size.x, size.y, size.z);
                model.scale.multiplyScalar(scale);
                
                let meshes = 0;
                model.traverse(n => { if (n.isMesh) meshes++; });
                
                document.getElementById('status').textContent = `✓ ${file.name} (${meshes} meshes)`;
                console.log('✓ Loaded:', meshes, 'meshes');
            }, null, (err) => {
                console.error('Error:', err);
                document.getElementById('status').textContent = `✗ ${err.message}`;
            });
        }

        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files[0]) loadModel(e.target.files[0]);
        });

        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', (e) => {
            e.preventDefault();
            if (e.dataTransfer.files[0]) loadModel(e.dataTransfer.files[0]);
        });

        // Start
        waitForTHREE(init);
    </script>
</body>
</html>
