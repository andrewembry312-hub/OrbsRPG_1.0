<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Map Generator</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 600px; }
    input, button { padding: 8px 12px; font-size: 14px; }
    button { background: #4a9eff; color: white; border: none; cursor: pointer; border-radius: 4px; }
    button:hover { background: #2a7edf; }
    .status { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>Map Generator</h1>
  <p>Load your PNG map and generate the world file:</p>
  
  <input type="file" id="mapFile" accept=".png" />
  <button onclick="generateMap()">Generate World File</button>
  
  <div id="status"></div>

  <script>
    async function generateMap() {
      const fileInput = document.getElementById('mapFile');
      const statusDiv = document.getElementById('status');
      
      if(!fileInput.files.length) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'Please select a PNG file';
        return;
      }
      
      const file = fileInput.files[0];
      statusDiv.textContent = 'Processing...';
      statusDiv.className = 'status';
      
      try {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          const imgData = ctx.getImageData(0, 0, img.width, img.height);
          const data = imgData.data;

          const mapWidth = img.width;
          const mapHeight = img.height;
          const trees = [];
          const mountains = [];
          const mountainCircles = [];
          const waterCircles = [];

          // Parse image pixels - sample every Nth pixel to reduce size
          const SAMPLE_RATE = 4; // Only process every 4th pixel
          for(let i = 0; i < data.length; i += 4 * SAMPLE_RATE) {
            const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
            if(a < 128) continue;
            
            const idx = i / 4;
            const x = (idx % img.width) * SAMPLE_RATE;
            const y = Math.floor(idx / img.width) * SAMPLE_RATE;

            // Black = Mountain
            if(r < 50 && g < 50 && b < 50) {
              const peaks = [];
              for(let j = 0; j < 2; j++) {
                const ox = (Math.random() - 0.5) * 40;
                const oy = (Math.random() - 0.5) * 40;
                const pr = 20 + Math.random() * 20;
                peaks.push({x: x + ox, y: y + oy, r: pr});
                mountainCircles.push({x: x + ox, y: y + oy, r: pr});
              }
              mountains.push({x, y, peaks});
            }
            // Blue = Water
            else if(r < 50 && g < 50 && b > 200) {
              const cr = 12 + Math.random() * 20;
              waterCircles.push({x, y, r: cr});
            }
            // Gray = Trees
            else if(r > 100 && g > 100 && b > 100 && Math.abs(r-g) < 30 && Math.abs(g-b) < 30) {
              trees.push({x, y, r: 10});
            }
          }

          // Generate sites
          const sites = [];
          const cornerPad = Math.min(140, Math.min(mapWidth, mapHeight) / 4);
          
          sites.push({ id:'player_base', name:'Player Base', x: cornerPad, y: mapHeight - cornerPad, r: 92, owner: 'player', prog: 1 });
          sites.push({ id:'team_a_base', name:'Red Base', x: cornerPad, y: cornerPad, r: 92, owner: 'teamA', prog: 1 });
          sites.push({ id:'team_b_base', name:'Yellow Base', x: mapWidth - cornerPad, y: cornerPad, r: 92, owner: 'teamB', prog: 1 });
          sites.push({ id:'team_c_base', name:'Blue Base', x: mapWidth - cornerPad, y: mapHeight - cornerPad, r: 92, owner: 'teamC', prog: 1 });

          const FLAG_COUNT = 6;
          for(let i = 0; i < FLAG_COUNT; i++) {
            let x, y, ok = false, tries = 0;
            while(!ok && tries < 120) {
              x = Math.random() * (mapWidth - 240) + 120;
              y = Math.random() * (mapHeight - 240) + 120;
              ok = true;
              for(const b of sites) {
                if(Math.hypot(b.x - x, b.y - y) < 220) {
                  ok = false;
                  break;
                }
              }
              tries++;
            }
            if(ok) sites.push({ id:`site_${i}`, name:`Flag ${i+1}`, x, y, r: 74, owner: null, prog: 0 });
          }

          // Add walls to bases
          for(const s of sites) {
            s.guardRespawns = [];
            s.spawnActive = false;
            s.underAttack = false;
            s._justCaptured = false;
            s._prevOwner = s.owner;
            
            if(s.id.endsWith('_base')) {
              const baseR = s.r + 28;
              const sides = [];
              for(let i = 0; i < 4; i++) {
                sides.push({ hp: 100, maxHp: 100, destroyed: false, lastDamaged: -9999 });
              }
              s.wall = {
                r: baseR,
                thickness: 14,
                gateSide: Math.floor(Math.random() * 4),
                sides: sides,
                cornerR: 10,
                repairCooldown: 5.0
              };
              s.wall.gateOpen = false;
            }
          }

          // Generate JavaScript code
          const filename = file.name.replace(/\.png$/i, '.world.js');
          const output = `// Generated world data from ${file.name}
export const generatedWorld = {
  mapWidth: ${mapWidth},
  mapHeight: ${mapHeight},
  trees: ${JSON.stringify(trees)},
  mountains: ${JSON.stringify(mountains)},
  mountainCircles: ${JSON.stringify(mountainCircles)},
  waterCircles: ${JSON.stringify(waterCircles)},
  sites: ${JSON.stringify(sites)}
};
`;

          // Download the file
          const blob = new Blob([output], {type: 'text/javascript'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);

          statusDiv.className = 'status success';
          statusDiv.innerHTML = `âœ“ Generated ${filename}<br>
            - ${trees.length} trees<br>
            - ${mountains.length} mountain clusters<br>
            - ${waterCircles.length} water tiles<br>
            - ${sites.length} sites<br><br>
            Save the file to: <code>assets/maps/${filename}</code>`;
        };
        img.onerror = () => {
          throw new Error('Failed to load image');
        };
        img.src = URL.createObjectURL(file);
      } catch(err) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'Error: ' + err.message;
      }
    }
  </script>
</body>
</html>
